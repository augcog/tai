.PHONY: help install dev test lint format clean
.PHONY: add add-dev remove update show
.PHONY: generate analyze visualize

# Find the root directory (where the main pyproject.toml is)
ROOT_DIR := $(shell cd ../.. && pwd)
POETRY_RUN = cd $(ROOT_DIR) && poetry run
PYTHON = $(POETRY_RUN) python

help: ## Show this help message
	@echo "Evaluation Tools - Dataset Generation & Analysis"
	@echo "=============================================="
	@echo ""
	@echo "ðŸ“¦ Installs to root monorepo - Package management modifies root"
	@echo ""
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)

install: ## Install dependencies from root monorepo
	@echo "ðŸ“¦ Installing Evaluation Tools dependencies from root monorepo..."
	@echo "ðŸ”— Using unified virtual environment at: $(ROOT_DIR)/.venv"
	cd $(ROOT_DIR) && poetry install
	@echo "âœ… Dependencies installed in unified virtual environment!"

dev: ## Start development environment
	@echo "ðŸš€ Starting Jupyter notebook server..."
	cd $(shell pwd) && $(POETRY_RUN) jupyter notebook

test: ## Run tests for evaluation tools
	@echo "ðŸ§ª Running evaluation tests..."
	$(POETRY_RUN) pytest -v tests/

test-no-api: ## Run tests without OpenAI API calls
	@echo "ðŸ§ª Running tests (excluding OpenAI API tests)..."
	$(POETRY_RUN) pytest -v -m "not openai" tests/

lint: ## Run linting on evaluation files only
	@echo "ðŸ” Running linting on evaluation files..."
	cd $(ROOT_DIR) && poetry run ruff check evaluation/dataset_generate/
	cd $(ROOT_DIR) && poetry run mypy evaluation/dataset_generate/src

format: ## Format evaluation code only
	@echo "ðŸŽ¨ Formatting evaluation code..."
	cd $(ROOT_DIR) && poetry run black evaluation/dataset_generate/
	cd $(ROOT_DIR) && poetry run ruff format evaluation/dataset_generate/

# Evaluation-specific commands
generate: ## Generate dataset (use: make generate CONFIG=config.yaml)
	@if [ -z "$(CONFIG)" ]; then echo "âŒ Usage: make generate CONFIG=config.yaml"; exit 1; fi
	@echo "ðŸ“Š Generating dataset with config: $(CONFIG)..."
	cd $(shell pwd) && $(PYTHON) src/generate.py --config $(CONFIG)

analyze: ## Analyze results (use: make analyze DATA=results.json)
	@if [ -z "$(DATA)" ]; then echo "âŒ Usage: make analyze DATA=results.json"; exit 1; fi
	@echo "ðŸ“ˆ Analyzing results: $(DATA)..."
	cd $(shell pwd) && $(PYTHON) src/analyze.py --data $(DATA)

visualize: ## Create visualizations (use: make visualize DATA=results.json)
	@if [ -z "$(DATA)" ]; then echo "âŒ Usage: make visualize DATA=results.json"; exit 1; fi
	@echo "ðŸ“Š Creating visualizations for: $(DATA)..."
	cd $(shell pwd) && $(PYTHON) src/visualize.py --data $(DATA)

# Package management - Always modifies root pyproject.toml
add: ## Add package to root monorepo (use: make add PKG=name)
	@if [ -z "$(PKG)" ]; then echo "âŒ Usage: make add PKG=package-name"; exit 1; fi
	@echo "ðŸ“¦ Adding package $(PKG) to root monorepo..."
	cd $(ROOT_DIR) && poetry add $(PKG)
	@echo "âœ… Package $(PKG) added to root!"

add-dev: ## Add dev package to root monorepo (use: make add-dev PKG=name)
	@if [ -z "$(PKG)" ]; then echo "âŒ Usage: make add-dev PKG=package-name"; exit 1; fi
	@echo "ðŸ“¦ Adding dev package $(PKG) to root monorepo..."
	cd $(ROOT_DIR) && poetry add --group dev $(PKG)
	@echo "âœ… Dev package $(PKG) added to root!"

remove: ## Remove package from root monorepo (use: make remove PKG=name)
	@if [ -z "$(PKG)" ]; then echo "âŒ Usage: make remove PKG=package-name"; exit 1; fi
	@echo "ðŸ“¦ Removing package $(PKG) from root monorepo..."
	cd $(ROOT_DIR) && poetry remove $(PKG)
	@echo "âœ… Package $(PKG) removed from root!"

update: ## Update dependencies in root monorepo
	@echo "â¬†ï¸  Updating dependencies in root monorepo..."
	cd $(ROOT_DIR) && poetry update
	@echo "âœ… Root dependencies updated!"

show: ## Show dependencies from root monorepo
	@echo "ðŸ“Š Showing dependencies from root monorepo:"
	cd $(ROOT_DIR) && poetry show

clean: ## Clean artifacts in evaluation directory
	@echo "ðŸ§¹ Cleaning evaluation artifacts..."
	@find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	@find . -type f -name "*.pyc" -delete 2>/dev/null || true
	@rm -rf .pytest_cache .mypy_cache
	@echo "âœ… Evaluation cleanup completed!"
