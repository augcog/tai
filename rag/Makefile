.PHONY: help install install-basic install-cv install-ocr install-full
.PHONY: dev test lint format clean
.PHONY: add add-dev remove update show
.PHONY: convert embed process
.PHONY: test-cv test-ocr test-ml
.PHONY: setup-models download-models

# Find the root directory (where the main pyproject.toml is)
ROOT_DIR := $(shell cd .. && pwd)
POETRY_RUN = cd $(ROOT_DIR) && poetry run
PYTHON = $(POETRY_RUN) python
PYTEST = $(POETRY_RUN) pytest

# Default target
help: ## Show this help message
	@echo "RAG Pipeline - Document Processing & Embedding Generation"
	@echo "========================================================"
	@echo ""
	@echo "üöÄ Quick Start:"
	@echo "  make install-basic    # Install core dependencies from root monorepo"
	@echo "  make install-full     # Install everything from root monorepo (large download!)"
	@echo ""
	@echo "üì¶ Installation Options (installs to root monorepo):"
	@awk 'BEGIN {FS = ":.*?## "} /^install.*:.*?## / {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo ""
	@echo "üõ†Ô∏è  Development Commands:"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST) | grep -E "(dev|test|lint|format|clean)"
	@echo ""
	@echo "üîÑ Processing Commands:"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST) | grep -E "(convert|embed|process|models)"
	@echo ""
	@echo "üì¶ Package Management (modifies root monorepo):"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST) | grep -E "(add|remove|update|show)"
	@echo ""
	@echo "üí° Examples:"
	@echo "  make convert INPUT=docs/ OUTPUT=processed/"
	@echo "  make add PKG=torch GROUP=ml-heavy      # Add to root monorepo"
	@echo "  make install-cv                       # Add CV support to root"
	@echo ""

# Installation commands - all install to root monorepo
install: install-basic ## Install basic dependencies from root (alias for install-basic)

install-basic: ## Install core dependencies from root monorepo (fastest)
	@echo "üì¶ Installing basic RAG dependencies from root monorepo..."
	@echo "üîó Using unified virtual environment at: $(ROOT_DIR)/.venv"
	cd $(ROOT_DIR) && poetry install
	@cd $(ROOT_DIR) && poetry env info --path | sed 's/^/üêç Virtual environment: /'
	@echo "‚úÖ Basic dependencies installed in unified virtual environment!"
	@echo "üí° For more features: make install-cv, make install-ocr, make install-full"

install-cv: ## Install with computer vision support in root monorepo
	@echo "üì¶ Installing with computer vision support in root monorepo..."
	cd $(ROOT_DIR) && poetry install --with cv
	@echo "‚úÖ Computer vision dependencies installed in root!"

install-ocr: ## Install with OCR support in root monorepo (large download)
	@echo "üì¶ Installing with OCR support in root monorepo (this may take a while)..."
	cd $(ROOT_DIR) && poetry install --with ocr
	@echo "‚úÖ OCR dependencies installed in root!"

install-ml-heavy: ## Install heavy ML packages in root monorepo for performance
	@echo "üì¶ Installing heavy ML packages in root monorepo..."
	cd $(ROOT_DIR) && poetry install --with ml-heavy
	@echo "‚úÖ Heavy ML packages installed in root!"

install-nlp: ## Install NLP processing packages in root monorepo
	@echo "üì¶ Installing NLP packages in root monorepo..."
	cd $(ROOT_DIR) && poetry install --with nlp
	@echo "‚úÖ NLP packages installed in root!"

install-video: ## Install video processing support in root monorepo
	@echo "üì¶ Installing video processing support in root monorepo..."
	cd $(ROOT_DIR) && poetry install --with video
	@echo "‚úÖ Video processing packages installed in root!"

install-web: ## Install web scraping support in root monorepo
	@echo "üì¶ Installing web scraping support in root monorepo..."
	cd $(ROOT_DIR) && poetry install --with web
	@echo "‚úÖ Web scraping packages installed in root!"

install-full: ## Install all features in root monorepo (LARGE download - 5GB+)
	@echo "üö® WARNING: This will download 5GB+ of dependencies!"
	@echo "üì¶ Installing ALL RAG features in root monorepo..."
	cd $(ROOT_DIR) && poetry install --with cv,ocr,ml-heavy,ml-training,video,web,formats
	@echo "‚úÖ Full installation complete in root! All features available."

install-dev: ## Install with development dependencies in root monorepo
	@echo "üì¶ Installing with development dependencies in root monorepo..."
	cd $(ROOT_DIR) && poetry install --with dev
	@echo "‚úÖ Development environment ready in root!"

# Development
dev: ## Start development server
	@echo "üöÄ Starting RAG development server..."
	cd $(shell pwd) && $(PYTHON) -m file_conversion_router.api

dev-api: ## Start FastAPI development server
	@echo "üöÄ Starting RAG API server..."
	cd $(shell pwd) && $(POETRY_RUN) uvicorn file_conversion_router.api:app --reload --port 8001

# Testing with feature-specific tests - tests only RAG files
test: ## Run basic tests for RAG components
	@echo "üß™ Running basic RAG tests..."
	$(PYTEST) -v -m "not slow and not cv and not ocr and not gpu" tests/

test-all: ## Run all RAG tests (requires full installation)
	@echo "üß™ Running all RAG tests..."
	$(PYTEST) -v tests/

test-unit: ## Run unit tests only for RAG
	@echo "üß™ Running RAG unit tests..."
	$(PYTEST) -v -m "unit" tests/

test-integration: ## Run integration tests for RAG
	@echo "üß™ Running RAG integration tests..."
	$(PYTEST) -v -m "integration" tests/

test-cv: ## Run computer vision tests (requires CV packages)
	@echo "üß™ Running computer vision tests..."
	$(PYTEST) -v -m "cv" tests/

test-ocr: ## Run OCR tests (requires OCR packages)
	@echo "üß™ Running OCR tests..."
	$(PYTEST) -v -m "ocr" tests/

test-ml: ## Run ML tests (requires ML packages)
	@echo "üß™ Running ML tests..."
	$(PYTEST) -v -m "not slow" --timeout=300 tests/

test-slow: ## Run slow/heavy tests
	@echo "üß™ Running slow tests (this may take a while)..."
	$(PYTEST) -v -m "slow" --timeout=1800 tests/

# Code quality - only checks RAG files
lint: ## Run linting checks on RAG files only
	@echo "üîç Running linting checks on RAG files..."
	cd $(ROOT_DIR) && poetry run ruff check rag/
	cd $(ROOT_DIR) && poetry run mypy rag/file_conversion_router --ignore-missing-imports
	@echo "‚úÖ RAG linting completed!"

format: ## Format RAG code only
	@echo "üé® Formatting RAG code..."
	cd $(ROOT_DIR) && poetry run black rag/
	cd $(ROOT_DIR) && poetry run ruff format rag/
	@echo "‚úÖ RAG code formatted!"

# RAG Processing commands
convert: ## Convert files (use: make convert INPUT=path/to/input OUTPUT=path/to/output)
	@if [ -z "$(INPUT)" ] || [ -z "$(OUTPUT)" ]; then \
		echo "‚ùå Usage: make convert INPUT=input_path OUTPUT=output_path"; \
		echo "Example: make convert INPUT=docs/ OUTPUT=processed/"; \
		exit 1; \
	fi
	@echo "üîÑ Converting files from $(INPUT) to $(OUTPUT)..."
	cd $(shell pwd) && $(PYTHON) -m file_conversion_router.api --input $(INPUT) --output $(OUTPUT)
	@echo "‚úÖ File conversion completed!"

embed: ## Create embeddings (use: make embed INPUT=processed/ OUTPUT=embeddings/)
	@if [ -z "$(INPUT)" ] || [ -z "$(OUTPUT)" ]; then \
		echo "‚ùå Usage: make embed INPUT=processed_path OUTPUT=embeddings_path"; \
		echo "Example: make embed INPUT=processed/ OUTPUT=embeddings/"; \
		exit 1; \
	fi
	@echo "üß† Creating embeddings from $(INPUT) to $(OUTPUT)..."
	cd $(shell pwd) && $(PYTHON) -m file_conversion_router.embedding.table_create --input $(INPUT) --output $(OUTPUT)
	@echo "‚úÖ Embedding creation completed!"

process: ## Full pipeline (use: make process INPUT=docs/ OUTPUT=final/)
	@if [ -z "$(INPUT)" ] || [ -z "$(OUTPUT)" ]; then \
		echo "‚ùå Usage: make process INPUT=input_path OUTPUT=output_path"; \
		echo "Example: make process INPUT=docs/ OUTPUT=final/"; \
		exit 1; \
	fi
	@echo "üîÑ Running full RAG pipeline..."
	@echo "Step 1: Converting files..."
	cd $(shell pwd) && $(PYTHON) -m file_conversion_router.api --input $(INPUT) --output $(OUTPUT)/processed
	@echo "Step 2: Creating embeddings..."
	cd $(shell pwd) && $(PYTHON) -m file_conversion_router.embedding.table_create --input $(OUTPUT)/processed --output $(OUTPUT)/embeddings
	@echo "‚úÖ Full pipeline completed!"

# Model management
download-models: ## Download required models
	@echo "üì• Downloading required models..."
	cd $(shell pwd) && $(PYTHON) -c "from file_conversion_router.services import download_base_models; download_base_models()"
	@echo "‚úÖ Models downloaded!"

setup-models: ## Setup and verify models
	@echo "üîß Setting up models..."
	cd $(shell pwd) && $(PYTHON) -c "from file_conversion_router.services import setup_models; setup_models()"
	@echo "‚úÖ Models setup completed!"

# Package management - Always modifies root pyproject.toml
add: ## Add production dependency to root monorepo (use: make add PKG=package-name [GROUP=group-name])
	@if [ -z "$(PKG)" ]; then echo "‚ùå Usage: make add PKG=package-name [GROUP=group-name]"; exit 1; fi
	@if [ -n "$(GROUP)" ]; then \
		echo "üì¶ Adding $(PKG) to group $(GROUP) in root monorepo..."; \
		cd $(ROOT_DIR) && poetry add --group $(GROUP) $(PKG); \
	else \
		echo "üì¶ Adding package $(PKG) to root monorepo..."; \
		cd $(ROOT_DIR) && poetry add $(PKG); \
	fi
	@echo "‚úÖ Package $(PKG) added to root!"

add-dev: ## Add development dependency to root monorepo (use: make add-dev PKG=package-name)
	@if [ -z "$(PKG)" ]; then echo "‚ùå Usage: make add-dev PKG=package-name"; exit 1; fi
	@echo "üì¶ Adding development package $(PKG) to root monorepo..."
	cd $(ROOT_DIR) && poetry add --group dev $(PKG)
	@echo "‚úÖ Development package $(PKG) added to root!"

add-optional: ## Add to optional group in root monorepo (use: make add-optional PKG=package GROUP=cv)
	@if [ -z "$(PKG)" ] || [ -z "$(GROUP)" ]; then \
		echo "‚ùå Usage: make add-optional PKG=package-name GROUP=group-name"; \
		echo "Available groups: cv, ocr, ml-heavy, nlp, video, web, formats"; \
		exit 1; \
	fi
	@echo "üì¶ Adding $(PKG) to optional group $(GROUP) in root monorepo..."
	cd $(ROOT_DIR) && poetry add --group $(GROUP) $(PKG)
	@echo "‚úÖ Package $(PKG) added to $(GROUP) group in root!"

remove: ## Remove dependency from root monorepo (use: make remove PKG=package-name)
	@if [ -z "$(PKG)" ]; then echo "‚ùå Usage: make remove PKG=package-name"; exit 1; fi
	@echo "üì¶ Removing package $(PKG) from root monorepo..."
	cd $(ROOT_DIR) && poetry remove $(PKG)
	@echo "‚úÖ Package $(PKG) removed from root!"

update: ## Update all dependencies in root monorepo
	@echo "‚¨ÜÔ∏è  Updating dependencies in root monorepo..."
	cd $(ROOT_DIR) && poetry update
	@echo "‚úÖ Root dependencies updated!"

show: ## Show dependency information from root monorepo
	@if [ -z "$(PKG)" ]; then \
		echo "üìä Showing all dependencies from root:"; \
		cd $(ROOT_DIR) && poetry show; \
	else \
		echo "üìä Showing package info: $(PKG)"; \
		cd $(ROOT_DIR) && poetry show $(PKG); \
	fi

show-groups: ## Show available dependency groups
	@echo "üìä Available dependency groups:"
	@echo "  Core: Always installed"
	@echo "  cv: Computer vision (OpenCV, image processing)"
	@echo "  ocr: OCR and document processing (heavy)"
	@echo "  ml-heavy: Performance ML packages"
	@echo "  ml-training: Training and fine-tuning"
	@echo "  video: Video processing"
	@echo "  web: Web scraping"
	@echo "  formats: Additional file formats"
	@echo "  full: Everything (5GB+ download)"

# Maintenance
clean: ## Clean build artifacts and cache in RAG directory
	@echo "üßπ Cleaning RAG build artifacts..."
	@find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name ".mypy_cache" -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	@find . -type f -name "*.pyc" -delete 2>/dev/null || true
	@rm -rf dist/ build/ .coverage htmlcov/ .tox/ .ruff_cache/
	@echo "‚úÖ RAG cleanup completed!"

clean-models: ## Clean downloaded model cache
	@echo "üßπ Cleaning model cache..."
	@rm -rf ~/.cache/huggingface/transformers/
	@rm -rf ~/.cache/torch/hub/
	@echo "‚úÖ Model cache cleaned!"

clean-outputs: ## Clean processing outputs in RAG directory
	@echo "üßπ Cleaning RAG processing outputs..."
	@rm -rf outputs/ processed/ embeddings/
	@echo "‚úÖ RAG output directories cleaned!"

# Virtual environment management - references root environment
venv-info: ## Show root virtual environment information
	@echo "üêç Root Virtual Environment Information"
	@echo "======================================="
	cd $(ROOT_DIR) && poetry env info

venv-activate: ## Show command to activate root virtual environment manually
	@echo "üêç To manually activate the root virtual environment, run:"
	@echo "cd $(ROOT_DIR) && source $$(cd $(ROOT_DIR) && poetry env info --path)/bin/activate"

venv-shell: ## Enter root virtual environment shell
	@echo "üêç Entering root virtual environment shell..."
	cd $(ROOT_DIR) && poetry shell

venv-remove: ## Remove root virtual environment
	@echo "üóëÔ∏è  Removing root virtual environment..."
	cd $(ROOT_DIR) && poetry env remove python
	@echo "‚úÖ Root virtual environment removed!"

venv-recreate: ## Recreate root virtual environment
	@echo "üîÑ Recreating root virtual environment..."
	cd $(ROOT_DIR) && poetry env remove python || true
	cd $(ROOT_DIR) && poetry install
	@echo "‚úÖ Root virtual environment recreated!"

# Information and debugging
info: ## Show environment and installation info
	@echo "‚ÑπÔ∏è  RAG Pipeline Environment"
	@echo "=========================="
	@echo "Python: $$(python --version 2>/dev/null || echo 'Not found')"
	@echo "Poetry: $$(poetry --version 2>/dev/null || echo 'Not found')"
	@echo "PyTorch: $$($(POETRY_RUN) python -c 'import torch; print(f\"PyTorch {torch.__version__} (CUDA: {torch.cuda.is_available()})\"' 2>/dev/null || echo 'Not installed')"
	@echo "Transformers: $$($(POETRY_RUN) python -c 'import transformers; print(transformers.__version__)' 2>/dev/null || echo 'Not installed')"
	@echo "OpenCV: $$($(POETRY_RUN) python -c 'import cv2; print(cv2.__version__)' 2>/dev/null || echo 'Not installed')"
	@echo "Working Directory: $$(pwd)"
	@echo "Root Directory: $(ROOT_DIR)"
	@echo ""
	@echo "üîß Feature Status:"
	@echo "Basic: ‚úÖ (always available)"
	@echo "CV: $$($(POETRY_RUN) python -c 'import cv2' 2>/dev/null && echo '‚úÖ Available' || echo '‚ùå Not installed')"
	@echo "OCR: $$($(POETRY_RUN) python -c 'import paddleocr' 2>/dev/null && echo '‚úÖ Available' || echo '‚ùå Not installed')"
	@echo "NLP: $$($(POETRY_RUN) python -c 'import spacy' 2>/dev/null && echo '‚úÖ Available' || echo '‚ùå Not installed')"

check-deps: ## Check if optional dependencies are installed
	@echo "üîç Checking optional dependencies..."
	@echo "Computer Vision:"
	@$(POETRY_RUN) python -c "import cv2; print('  ‚úÖ OpenCV available')" 2>/dev/null || echo "  ‚ùå OpenCV not installed (make install-cv)"
	@echo "OCR:"
	@$(POETRY_RUN) python -c "import paddleocr; print('  ‚úÖ PaddleOCR available')" 2>/dev/null || echo "  ‚ùå PaddleOCR not installed (make install-ocr)"
	@echo "NLP:"
	@$(POETRY_RUN) python -c "import spacy; print('  ‚úÖ spaCy available')" 2>/dev/null || echo "  ‚ùå spaCy not installed (make install-nlp)"
	@echo "Video:"
	@$(POETRY_RUN) python -c "import moviepy; print('  ‚úÖ MoviePy available')" 2>/dev/null || echo "  ‚ùå MoviePy not installed (make install-video)"

# Quick setup workflows
setup-basic: install-basic download-models ## Quick setup with basic features in root monorepo
	@echo "üéâ Basic RAG setup complete in root monorepo!"
	@echo "Try: make convert INPUT=your_docs/ OUTPUT=processed/"

setup-full: install-full download-models ## Complete setup with all features in root monorepo
	@echo "üéâ Full RAG setup complete in root monorepo!"
	@echo "All features available including OCR, CV, NLP, and video processing."

# Benchmarking and performance
benchmark: ## Run performance benchmarks
	@echo "‚ö° Running performance benchmarks..."
	cd $(shell pwd) && $(PYTHON) -m file_conversion_router.benchmarks.run_benchmarks
	@echo "‚úÖ Benchmarks completed!"
